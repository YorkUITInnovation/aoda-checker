<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAML Configuration - AODA Compliance Checker</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
        }

        .form-section {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .form-section h3 {
            color: #0d6efd;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0d6efd;
        }

        .metadata-import-box {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .help-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 5px;
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            color: #d63384;
        }
    </style>
</head>
<body>
    <!-- Skip link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    {% include 'includes/navbar.html' %}
    {% include 'includes/sidebar.html' %}

    <!-- Main Content -->
    <div class="container main-content">
        <main id="main-content">
            <h2 class="mb-4">
                <i class="bi bi-key-fill"></i> SAML2 Authentication Configuration
            </h2>

            <!-- Alerts -->
            <div id="alert-container"></div>

            <form id="saml-config-form">
                <!-- Section 1: Generate Certificates -->
                <div class="form-section">
                    <h3><i class="bi bi-file-earmark-lock"></i> 1. Generate Service Provider Certificates</h3>
                    <p>Generate self-signed certificates for signing SAML requests.</p>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Common Name (CN):</label>
                            <input type="text" class="form-control" id="cert_cn" value="localhost" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Organization:</label>
                            <input type="text" class="form-control" id="cert_org" value="Organization" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Country Code (2 letters):</label>
                            <input type="text" class="form-control" id="cert_country" value="CA" maxlength="2" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">State/Province:</label>
                            <input type="text" class="form-control" id="cert_state" value="ON" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">City:</label>
                            <input type="text" class="form-control" id="cert_city" value="Toronto" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email:</label>
                            <input type="email" class="form-control" id="cert_email" value="admin@example.com" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Organizational Unit:</label>
                            <input type="text" class="form-control" id="cert_ou" value="IT" required>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary mt-3" id="generate-cert-btn">
                        <i class="bi bi-plus-circle"></i> Generate Certificates
                    </button>
                    {% if certs_exist %}
                    <span class="badge bg-success ms-2">Certificates exist</span>
                    {% endif %}
                    <div id="cert-message" class="mt-3"></div>
                </div>

                <!-- Section 2: Enable SAML2 -->
                <div class="form-section">
                    <h3><i class="bi bi-toggle-on"></i> 2. Enable SAML2 Authentication</h3>

                    <div class="alert alert-warning">
                        <h5 class="alert-heading">
                            <i class="bi bi-exclamation-triangle"></i> Important
                        </h5>
                        <p><strong>Before enabling SAML2, ensure:</strong></p>
                        <ul>
                            <li>You have generated certificates</li>
                            <li>Your SP URLs match where this app is running</li>
                            <li>You have configured your IdP connection</li>
                            <li>You have shared your metadata.xml with the IdP administrator</li>
                        </ul>
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enabled" name="enabled"
                               {% if config.enabled %}checked{% endif %} style="width: 3em; height: 1.5em;">
                        <label class="form-check-label fw-bold fs-5" for="enabled">
                            Enable SAML2 Authentication
                        </label>
                    </div>
                </div>

                <!-- Section 3: Service Provider Configuration -->
                <div class="form-section">
                    <h3><i class="bi bi-building"></i> 3. Service Provider (SP) Configuration</h3>

                    <div class="alert alert-info">
                        <strong>Example URLs for this application:</strong>
                        <ul class="mb-0">
                            <li>SP Entity ID: <code>http://localhost:8080/saml/metadata</code></li>
                            <li>ACS URL: <code>http://localhost:8080/saml/acs</code></li>
                            <li>SLS URL: <code>http://localhost:8080/saml/sls</code></li>
                        </ul>
                        <p class="mt-2 mb-0"><small>Replace with your actual domain for production (use HTTPS)</small></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">SP Entity ID:</label>
                        <input type="url" class="form-control" name="sp_entity_id" id="sp_entity_id"
                               value="{{ config.sp_entity_id }}"
                               placeholder="http://localhost:8080/saml/metadata" required>
                        <div class="help-text">Unique identifier for your application</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Assertion Consumer Service (ACS) URL:</label>
                        <input type="url" class="form-control" name="sp_acs_url" id="sp_acs_url"
                               value="{{ config.sp_acs_url }}"
                               placeholder="http://localhost:8080/saml/acs" required>
                        <div class="help-text">URL where SAML responses will be posted</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Single Logout Service (SLS) URL:</label>
                        <input type="url" class="form-control" name="sp_sls_url" id="sp_sls_url"
                               value="{{ config.sp_sls_url }}"
                               placeholder="http://localhost:8080/saml/sls">
                        <div class="help-text">URL for handling logout requests</div>
                    </div>

                    <div class="mt-3">
                        <a href="/api/admin/saml-download-metadata" class="btn btn-success" id="download-metadata-btn">
                            <i class="bi bi-download"></i> Download Metadata.xml
                        </a>
                        <small class="text-muted ms-2">Share this file with your IdP administrator</small>
                    </div>
                </div>

                <!-- Section 4: Identity Provider Configuration -->
                <div class="form-section">
                    <h3><i class="bi bi-diagram-3"></i> 4. Identity Provider (IdP) Configuration</h3>

                    <!-- IdP Metadata Import -->
                    <div class="metadata-import-box">
                        <h5 class="mb-3">
                            <i class="bi bi-cloud-download"></i> Import IdP Metadata (Recommended)
                        </h5>

                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="metadata_source"
                                       id="import-url" value="url" checked>
                                <label class="form-check-label" for="import-url">Import from URL</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="metadata_source"
                                       id="import-xml" value="xml">
                                <label class="form-check-label" for="import-xml">Paste XML content</label>
                            </div>
                        </div>

                        <div id="metadata-url-section">
                            <div class="mb-3">
                                <label class="form-label fw-bold">IdP Metadata URL:</label>
                                <input type="url" class="form-control" id="idp_metadata_url"
                                       placeholder="https://idp.example.com/metadata.xml">
                                <div class="help-text">Enter the URL where your IdP's metadata is hosted</div>
                            </div>
                        </div>

                        <div id="metadata-xml-section" class="d-none">
                            <div class="mb-3">
                                <label class="form-label fw-bold">IdP Metadata XML:</label>
                                <textarea class="form-control" id="idp_metadata_xml" rows="8"
                                          placeholder="Paste your IdP metadata XML here..."></textarea>
                                <div class="help-text">Paste the complete XML metadata from your Identity Provider</div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" id="import-metadata-btn">
                            <i class="bi bi-cloud-download"></i> Import Metadata
                        </button>
                        <div id="import-message" class="mt-3"></div>
                    </div>

                    <h5 class="mb-3">Manual IdP Configuration</h5>

                    <div class="mb-3">
                        <label class="form-label fw-bold">IdP Entity ID:</label>
                        <input type="text" class="form-control" id="idp_entity_id" name="idp_entity_id"
                               value="{{ config.idp_entity_id }}"
                               placeholder="https://idp.example.com/metadata" required>
                        <div class="help-text">Entity ID from your Identity Provider's metadata</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">IdP Single Sign-On URL:</label>
                        <input type="url" class="form-control" id="idp_sso_url" name="idp_sso_url"
                               value="{{ config.idp_sso_url }}"
                               placeholder="https://idp.example.com/sso" required>
                        <div class="help-text">SSO endpoint URL from your Identity Provider</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">IdP Single Logout URL:</label>
                        <input type="url" class="form-control" id="idp_sls_url" name="idp_sls_url"
                               value="{{ config.idp_sls_url }}"
                               placeholder="https://idp.example.com/slo">
                        <div class="help-text">SLO endpoint URL from your Identity Provider (optional)</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">IdP X.509 Certificate:</label>
                        <textarea class="form-control font-monospace" id="idp_x509_cert" name="idp_x509_cert"
                                  rows="6" required>{{ config.idp_x509_cert }}</textarea>
                        <div class="help-text">Public certificate from your Identity Provider (without BEGIN/END lines, just the certificate content)</div>
                    </div>
                </div>

                <!-- Section 5: Organization Info -->
                <div class="form-section">
                    <h3><i class="bi bi-building-add"></i> 5. Organization Information (Optional)</h3>
                    <p>This information will be included in the metadata.xml file.</p>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Organization Name:</label>
                            <input type="text" class="form-control" name="org_name" id="org_name"
                                   value="{{ config.org_name }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Display Name:</label>
                            <input type="text" class="form-control" name="org_display_name" id="org_display_name"
                                   value="{{ config.org_display_name }}">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Organization URL:</label>
                            <input type="url" class="form-control" name="org_url" id="org_url"
                                   value="{{ config.org_url }}">
                        </div>
                    </div>
                </div>

                <!-- Section 6: Contact Info -->
                <div class="form-section">
                    <h3><i class="bi bi-envelope"></i> 6. Contact Information (Optional)</h3>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Technical Contact Email:</label>
                        <input type="email" class="form-control" name="technical_contact_email" id="technical_contact_email"
                               value="{{ config.technical_contact_email }}">
                    </div>
                </div>

                <!-- Section 7: Attribute Mapping -->
                <div class="form-section">
                    <h3><i class="bi bi-arrow-left-right"></i> 7. Attribute Mapping</h3>
                    <p>Map SAML response attributes to user fields in the database.</p>

                    <div class="alert alert-info">
                        <strong>Example mapping:</strong>
                        <pre class="mb-0"><code>{
  "email": "email",
  "givenName": "first_name",
  "sn": "last_name",
  "employeeNumber": "id_number"
}</code></pre>
                        <p class="mt-2 mb-0"><small>The keys are SAML attribute names, the values are user database fields.</small></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Attribute Mapping (JSON):</label>
                        <textarea class="form-control font-monospace" name="attribute_mapping" id="attribute_mapping"
                                  rows="6">{{ attribute_mapping_json }}</textarea>
                        <div class="help-text">Define how SAML attributes map to user database fields</div>
                    </div>
                </div>

                <!-- Section 8: Auto-Provisioning -->
                <div class="form-section">
                    <h3><i class="bi bi-person-plus"></i> 8. Auto-Provisioning Settings</h3>

                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="auto_provision_users" name="auto_provision_users"
                               {% if config.auto_provision_users %}checked{% endif %} style="width: 3em; height: 1.5em;">
                        <label class="form-check-label fw-bold" for="auto_provision_users">
                            Automatically Create User Accounts on First Login
                        </label>
                        <div class="help-text">If enabled, users logging in via SAML without an account will have one created automatically</div>
                    </div>

                    <div class="mb-3 form-check">
                        <input class="form-check-input" type="checkbox" id="default_user_role_is_admin" name="default_user_role_is_admin"
                               {% if config.default_user_role_is_admin %}checked{% endif %}>
                        <label class="form-check-label" for="default_user_role_is_admin">
                            New Users are Administrators
                        </label>
                        <div class="help-text">If checked, auto-provisioned users will have admin privileges</div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save"></i> Save Configuration
                    </button>
                </div>
            </form>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/saml_config.js"></script>
</body>
</html>


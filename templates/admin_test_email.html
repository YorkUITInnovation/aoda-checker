<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Email - AODA Compliance Checker</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom styles -->
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Skip link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    {% include 'includes/navbar.html' %}
    {% include 'includes/sidebar.html' %}

    <!-- Main Content -->
    <div class="container main-content">
        <main id="main-content">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="display-5 fw-bold">
                        <i class="bi bi-envelope-check"></i> Test Email Configuration
                    </h1>
                    <p class="text-muted">
                        Send a test email to verify your SMTP configuration is working correctly.
                    </p>
                </div>
            </div>

            <!-- SMTP Configuration Info -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Current SMTP Configuration</h5>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-3">SMTP Host:</dt>
                                <dd class="col-sm-9"><code>{{ smtp_config.host }}</code></dd>

                                <dt class="col-sm-3">SMTP Port:</dt>
                                <dd class="col-sm-9"><code>{{ smtp_config.port }}</code></dd>

                                <dt class="col-sm-3">Username:</dt>
                                <dd class="col-sm-9"><code>{{ smtp_config.username if smtp_config.username else '(not configured)' }}</code></dd>

                                <dt class="col-sm-3">Use TLS:</dt>
                                <dd class="col-sm-9">
                                    {% if smtp_config.use_tls %}
                                        <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                        <span class="badge bg-warning">Disabled</span>
                                    {% endif %}
                                </dd>

                                <dt class="col-sm-3">From Email:</dt>
                                <dd class="col-sm-9"><code>{{ smtp_config.from_email }}</code></dd>

                                <dt class="col-sm-3">From Name:</dt>
                                <dd class="col-sm-9"><code>{{ smtp_config.from_name }}</code></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Email Form -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-send"></i> Send Test Email</h5>
                        </div>
                        <div class="card-body">
                            <form id="testEmailForm">
                                <div class="mb-3">
                                    <label for="testEmail" class="form-label fw-semibold">
                                        Recipient Email Address <span class="text-danger">*</span>
                                    </label>
                                    <input
                                        type="email"
                                        class="form-control"
                                        id="testEmail"
                                        name="test_email"
                                        placeholder="email@example.com"
                                        required
                                    >
                                    <small class="text-muted">Enter the email address where you want to send the test email.</small>
                                </div>

                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Note:</strong> This will send a test email to verify your SMTP configuration. Check your spam folder if you don't receive it.
                                </div>

                                <div id="alertContainer"></div>

                                <button type="submit" class="btn btn-primary" id="sendBtn">
                                    <i class="bi bi-send"></i> Send Test Email
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('testEmailForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const testEmail = document.getElementById('testEmail').value;
            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn.innerHTML;
            const alertContainer = document.getElementById('alertContainer');

            // Clear previous alerts
            alertContainer.innerHTML = '';

            // Disable button and show loading
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

            try {
                const response = await fetch('/api/admin/test-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ test_email: testEmail })
                });

                const result = await response.json();

                if (response.ok) {
                    // Success
                    alertContainer.innerHTML = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle-fill"></i>
                            <strong>Success!</strong> Test email sent successfully to ${testEmail}.
                            <br><small>Check your inbox (and spam folder) for the test email.</small>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                } else {
                    // Error
                    alertContainer.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>Failed!</strong> ${result.detail || 'Failed to send test email.'}
                            <br><small>Please check your SMTP configuration in the .env file.</small>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                }
            } catch (error) {
                alertContainer.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Error!</strong> An error occurred while sending the test email.
                        <br><small>${error.message}</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            } finally {
                // Re-enable button
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
            }
        });
    </script>
</body>
</html>

